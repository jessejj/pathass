<!DOCTYPE html>
<head>
    <title>Pathology Assistant</title>
 
	<HTA:APPLICATION
		ID = "PA"
		ApplicationName = "PathologyAssistant"
        VERSION="6d972a62561bf84c4bfe2d7dd5b20d2d5aea33a2"
        SINGLEINSTANCE = "Yes"
        SCROLL="no"
        BORDER="thin"
        INNERBORDER="no"
        MAXIMIZEBUTTON="no"
		SELECTION="no"
        
    />
<style>

#footer {
    width:100%;
    height:80px;
    position:absolute;
    bottom:0;
}

.checkbox {
        width: 30px;
        height: 30px;
      }

</style>
</head>

<script lang="javascript">

	window.onload = (function main(){
		//resetRegKeys();
		window.resizeTo(700, 900);
		ClearIDs();
		document.getElementById("footer-msg").innerHTML = "Checking for updates";

		o = new XMLHttpRequest();
		o.open("GET", "https://api.github.com/repos/jessepelley/pathologyAssistant/tags", false);
		o.send();

		if (o.status == 200) {
			json = o.responseText;
		}

		document.getElementById("title").innerHTML = "Pathology Assistant App";

		if (json.indexOf(PA.version) == -1) {
			UpdateText = "<input type='button' onclick='openLink()' value='Update'><br><i>Unsupported Version</i>";
			Supported = false;
		} else {
			UpdateText = "Supported Version";
			Supported = true;
		}

		document.getElementById("footer-msg").innerHTML = UpdateText;

		if (Supported) {
			for (i = 1; i < 11; i++){
			document.getElementById(i).disabled = false;
			}

			document.getElementById(1).innerHTML = '<button class="button" type="button" onclick="Cassettes()">Cassettes</button>';
			document.getElementById(2).innerHTML = '<button class="button" type="button" onclick="Commands()">Commands</button>';
			document.getElementById(3).innerHTML = '<button class="button" type="button" onclick="PowerPathSetup()">PowerPath Setup</button>';

		}
		document.getElementById(4).innerHTML = '<button class="button" type="button" onclick="Help()">Help</button>';
	})

	function Help() {
		helpURL = "https://outlook.office.com/mail/deeplink/compose?to=jpelley@eorla.ca&subject=Pathology%20Assistant%20App&body=%0A%0A%0A%0A%0A%0A%0A%0A%0A%0AApp%20Version%20";
		var shell = new ActiveXObject("wscript.shell");
		shell.run(helpURL + PA.version);
	}		
	
	function Commands() {
		ClearIDs();
		document.getElementById("Back").disabled = false;
		document.getElementById("title").innerHTML = "Commands";
		document.getElementById("1").innerHTML = '<button class="button" type="button" onclick="" disabled>Delete block</button>';
		document.getElementById("2").innerHTML = '<button class="button" type="button" onclick="" disabled>Duplicate block</button>';
		document.getElementById("3").innerHTML = '<button class="button" type="button" onclick="" disabled>Next block</button>';
		document.getElementById("4").innerHTML = '<button class="button" type="button" onclick="" disabled>My Signature</button>';
	}	
	
	function PowerPathSetup() {
		ClearIDs();
		PowerPathDBHTML = '<input class="checkbox" onchange=EnableApplyButton() type="checkbox" id="PowerPathDB" name="PowerPathDB" value="PowerPathDB"><label for="PowerPathDB"> Database set to CLPATHDB01</label>';

		document.getElementById("Back").disabled = false;
		document.getElementById("title").innerHTML = "PowerPath Setup";
		document.getElementById("1").innerHTML = PowerPathDBHTML;
	}

	function Cassettes(){
		if (Supported){
			ClearIDs();
			checkRegKeys();
			CASoptionsHTML = "<option value = ''></option><option value = 'CIV-GRO-CAS1'>CIV-GRO-CAS1</option>";
			PowerPathCassettesHTML = "PowerPath Auto Print: <select onchange=EnableApplyButton() name = 'CAS' id = 'CAS'>" + CASoptionsHTML + "</select>";
			BinHTML = "Exit bin: <select onchange=EnableApplyButton() name = 'ExitBin' id = 'ExitBin'> <option value = 'ExitBin1' selected>Bin 1</option><option value = 'ExitBin2'>Bin 2</option><option value = 'ExitBin3'>Bin 3</option></select>";

			document.getElementById("Back").disabled = false;
			document.getElementById("title").innerHTML = "Cassettes";
			document.getElementById("1").innerHTML = PowerPathCassettesHTML;
			document.getElementById("2").innerHTML = BinHTML;
			document.getElementById("Apply").onclick = function() {ApplyCassettes()}
		}
	}

	function EnableApplyButton(){
		document.getElementById("Apply").disabled = false;
	}

	function ApplyCassettes(){
		selectedExitBin = document.getElementById("ExitBin").value;
		if (selectedExitBin == "ExitBin2" || selectedExitBin == "ExitBin3") {
			shell = new ActiveXObject("wscript.shell");
			shell.run ('%comspec% /K title Cassette Script | cscript.exe /nologo Resources/"Pathology Assistant.vbs" Cassettes ' + document.getElementById("ExitBin").value);
		}

		if (selectedExitBin == "ExitBin1") {
			resetRegKeys();
			//shell = new ActiveXObject("wscript.shell");
			//shell.run("taskkill.exe /FI 'WINDOWTITLE Cassette Script'");
		}

		document.getElementById("Apply").disabled = true;
	}

	function resetRegKeys(){
		shell = new ActiveXObject("wscript.shell");
		CassetteFolder = "C:\\Cassettes\\";
		PrinterDir = "\\\\CLPATHIF01\\DIS_SHARE\\"
		RegKey1 = "HKLM\\SOFTWARE\\Wow6432Node\\IMPAC\\PseudoDriver\\";
		RegKey2 = "\\v1.0\\Directory Path";
		C1 = RegKey1 + "CIV-GRO-CAS1" + RegKey2;

		if (shell.regread(C1) == CassetteFolder) {
			shell.regwrite(C1, PrinterDir, "REG_SZ")
		}
	}

	function checkRegKeys(){
		shell = new ActiveXObject("wscript.shell");
		CassetteFolder = "C:\\Cassettes\\";
		PrinterDir = "\\\\CLPATHIF01\\DIS_SHARE\\"
		RegKey1 = "HKLM\\SOFTWARE\\Wow6432Node\\IMPAC\\PseudoDriver\\";
		RegKey2 = "\\v1.0\\Directory Path";
		C1 = RegKey1 + "CIV-GRO-CAS1" + RegKey2;

		if (shell.regread(C1) == CassetteFolder) {
			EnableApplyButton();
		}
	}

	function ClearIDs(){
		for (i = 1; i < 11; i++){
			document.getElementById(i).innerHTML = "&nbsp;";
		}
	}

	function openLink(){
		var shell = new ActiveXObject("wscript.shell");
		shell.run("https://github.com/jessepelley/pathologyAssistant/releases");
	}

	function test(){
		//runScript("test script", "test")
		readScript("test script", "test")
	}

	function runScript(scriptName, script, arg){
		shell = new ActiveXObject("wscript.shell");
		blah = shell.exec ('%comspec% /K title ' + scriptName + ' | cscript.exe /nologo Resources/"Pathology Assistant.vbs" ' + script + ' ' + arg);
		alert(blah.StdOut.ReadAll());
	}

	function readScript(scriptName, script, arg){
		shell = new ActiveXObject("wscript.shell");
		blah = shell.exec ('cscript.exe Resources/"Pathology Assistant.vbs" ' + script + ' ' + arg);
		document.getElementById(5).innerHTML = "ProcessID: " + blah.ProcessID;
		//alert(blah.StdOut.ReadLine());
		//do {
		//	document.getElementById(6).innerHTML = blah.StdOut.ReadLine();
		//} while (! blah.Stdout.atEndOfStream);
		setInterval(function(){ document.getElementById(6).innerHTML = blah.StdOut.ReadLine(); }, 1000);
		
	}
	
</script>

<body style="font-family:'Segoe UI', Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif; margin: 30px; line-height: normal" >

<h1 style="text-align:center" id="title">Please extract the archive and uncheck the 'Always ask before opening this file' box before running.</h1><p id="1"></p>
<p id="2"></p>
<p id="3"></p>
<p id="4"></p>
<p id="5"></p>
<p id="6"></p>
<p id="7"></p>
<p id="8"></p>
<p id="9"></p>
<p id="10"></p>
</body>
<div id=footer>
	<input class="button" type=button value="Back" id="Back" onClick="window.location.reload()" disabled> <input class="button" type=button value="Apply" id="Apply" onClick="" disabled>
	<div id="footer-msg"></div>
</div>
</html>
